---
title: "Preliminary Results"
author: "Mathew Kiang"
date: "2/22/2022"
output: 
  html_document:
    toc: true
    code_folding: 'hide'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(error = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

## Introduction

Did COVID-19 just reflect pre-existing inequalities or did it exacerbate them? That is, on the ratio scale, did the mortality of non-white groups change after the pandemic (relative to the non-Hispanic white population)?

To do this, I'm going to compare age-standardized (monthly) all-cause mortality rates for 6 racial/ethnic groups compared to non-Hispanic white. We will use a simple joinpoint model (with up to 9 joinpoints) to estimate temporal trends. Note that the confidence intervals on the age-standardized mortality rates are (I think) correct, but I'm less sure about the variance estimates I used for the rate ratio â€” the confidence intervals are *very* small which might not be impossible since non-Hispanic white is the denominator and there are a lot of them. 

## Set up

```{r}
library(tidyverse)
library(here)
library(DT)
source(here("code", "mk_nytimes.R"))

age_std <- readRDS(here("data", "joinpoint_std_rate_results.RDS"))
rr_df <- readRDS(here("data", "joinpoint_rate_ratio_results.RDS"))
```

## Joinpoint smoothed monthly age-standardized mortality rates

First, let's just look at the age-standardized mortality rates for all groups. The vertical dashed line is March 2020. Note that everybody (including non-Hispanic white) saw some bump after March 2020 relative to the historic period. The question of interest is whether or not these bumps were relatively the same (on the ratio scale) across groups. 

```{r}
ggplot(age_std, 
       aes(x = date, 
           color = race_cat, 
           group = race_cat)) +
    geom_vline(xintercept = as.Date("2020-03-01"),
               linetype = "dashed",
               alpha = .5) + 
    geom_pointrange(
        aes(
            y = all_cause_rate,
            ymax = all_cause_rate + 1.96 * all_cause_var,
            ymin = all_cause_rate - 1.96 * all_cause_var
        ),
        size = .15, 
        alpha = .5
    ) + 
    geom_line(aes(y = modeled_rate)) + 
    facet_wrap(~ race_cat,
               nrow = 2) + 
    scale_color_brewer("Race/Ethnicity", palette = "Dark2") + 
    scale_x_date(NULL, 
                 breaks = as.Date(sprintf("%s-01-01", 2018:2022)),
                 labels = paste0("'", substr(2018:2022, 3, 4))) + 
    scale_y_continuous("Monthly all-cause mortality rate (per 100,000)") + 
    mk_nytimes(legend.position = "none")
```

### Table of monthly age standardized mortality rates by race
```{r}
age_std %>% 
    transmute(race_eth,
              date, 
              all_cause_rate = sprintf("%0.2f", round(all_cause_rate, 2)),
              all_cause_var = sprintf("%0.2f", round(all_cause_var, 2)), 
              modeled_rate = sprintf("%0.2f", round(modeled_rate, 2)), 
              modeled_se = sprintf("%0.2f", round(modeled_se, 2))) %>% 
    DT::datatable(rownames = NULL)
```

### Table of monthly percent change (MPC) of the mortality rates
```{r}
age_std %>%
    transmute(
        race_eth,
        segment,
        date,
        mpc = sprintf(
            "%0.1f%% (%0.1f, %0.1f)",
            round(mpc, 1),
            round(mpc_lower, 1),
            round(mpc_upper, 1)
        ),
        mpc_pval = round(mpc_pval, 3)
    ) %>%
    group_by(race_eth, segment) %>%
    slice(1) %>%
    ungroup() %>% 
    DT::datatable(rownames = NULL)
```


## Joinpoint smoothed monthly rate ratios

To answer that question, I take the (raw, unsmoothed) monthly rate ratios from above, calculate the variance, and again then fit a different set of joinpoint models (again with up to 9 joins) on the rate ratio. 

```{r}
ggplot(rr_df, 
       aes(x = date, 
           color = race_cat, 
           group = race_cat)) +
    geom_hline(yintercept = 1,
               linetype = "dashed",
               alpha = .5) + 
    geom_vline(xintercept = as.Date("2020-03-01"),
               linetype = "dashed",
               alpha = .5) + 
    geom_pointrange(
        aes(
            y = rr,
            ymax = rr + 1.96 * rr_var,
            ymin = rr - 1.96 * rr_var
        ),
        size = .15, 
        alpha = .5
    ) + 
    geom_line(aes(y = modeled_rr)) + 
    facet_wrap(~ race_cat,
               ncol = 4) + 
    scale_color_brewer("Race/Ethnicity", palette = "Dark2") + 
    scale_x_date(NULL, 
                 breaks = as.Date(sprintf("%s-01-01", 2018:2022)),
                 labels = paste0("'", substr(2018:2022, 3, 4))) + 
    scale_y_continuous("All-cause mortality rate ratio",
                       trans = "log",
                       breaks = c(1/2, 3/4, 1, 4/3, 2),
                       labels = c(".5", ".75", "1", "1.33", "2")) + 
    mk_nytimes(legend.position = "none")
```

### Table of monthly rate ratios by race
```{r}
rr_df %>% 
    transmute(race_eth,
              date, 
              rr = sprintf("%0.2f", round(rr, 2)),
              rr_var = sprintf("%0.2f", round(rr_var, 2)), 
              modeled_rr = sprintf("%0.2f", round(modeled_rr, 2)), 
              modeled_se = sprintf("%0.2f", round(modeled_se, 2))) %>% 
    DT::datatable(rownames = NULL)
```

### Table of monthly percent change (MPC) of the rate ratios
```{r}
rr_df %>%
    transmute(
        race_eth,
        segment,
        date,
        mpc = sprintf(
            "%0.1f%% (%0.1f, %0.1f)",
            round(mpc, 1),
            round(mpc_lower, 1),
            round(mpc_upper, 1)
        ),
        mpc_pval = round(mpc_pval, 3)
    ) %>%
    group_by(race_eth, segment) %>%
    slice(1) %>%
    ungroup() %>% 
    DT::datatable(rownames = NULL)
```
## Table of the overall monthly percent change

Notably, for the most part the average monthly percent change over the entire time period is more or less ~0% indicating there's no strong secular trend. 

```{r}
rr_df %>%
    transmute(
        race_eth,
        ampc = sprintf(
            "%0.1f%% (%0.1f, %0.1f)",
            round(ampc, 1),
            round(ampc_lower, 1),
            round(ampc_upper, 1)
        ),
        ampc_pval = round(mpc_pval, 3)
    ) %>%
    group_by(race_eth) %>%
    slice(1) %>%
    ungroup() %>% 
    DT::datatable(rownames = NULL)
```

